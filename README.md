# stdin2list

## これはなに

C言語の研修課題(こんなプログラム作れ)に取り組んだ結果だよ。

標準入力から取得した文字列をソートして指定されたファイルに出力するやつだよ。

## なにすればいいの

```
$ git clone https://github.com/ossan-pg/stdin2list.git
$ cd stdin2list/
$ make
```

## つかいかた

```
stdin2list <file>
```

詳細については下記を読んでね。

## 説明

`stdin2list` は標準入力から複数の文字列を読み込み、`file` に追記する。
このとき `file` が存在しなければ作成する。

`file` が指定されていない場合、標準エラーに下記のメッセージを出力して処理を終了する。

```
出力用のファイルが指定されていません。プログラムを終了します。
```

`file` のオープンに失敗した場合、標準エラーに下記のメッセージを出力して処理を終了する。

```
ファイル 'file' のオープンに失敗しました。プログラムを終了します。
```

標準入力から文字列を読み込む際はユーザに対し下記のようにプロンプトを表示する。
```
1個目の文字列を入力して下さい。：xxx
2個目の文字列を入力して下さい。：aaa
3個目の文字列を入力して下さい。：
```

長さが 0 の文字列を読み込んだ(ユーザが何も入力せずエンターキーを押した)場合、
文字列の読み込みを終了する。

その後、これまでに読み込んだ文字列を文字コードで昇順にソートし `file` に追記する。

文字列の追記後は空行をファイルに出力してプログラムを終了する。

```
$ cat output.txt
zzz

$ ./stdin2list output.txt
1個目の文字列を入力して下さい。：xxx
2個目の文字列を入力して下さい。：aaa
3個目の文字列を入力して下さい。：bbb
4個目の文字列を入力して下さい。：
文字列のソート結果をファイルに出力しました。
$ cat output.txt
zzz

aaa
bbb
xxx

```

### 有効な文字列

文字列は半角英数字のみを有効なものとし、それ以外の文字が含まれていた場合は
標準エラーに下記のメッセージを出力して処理を終了する。

```
半角英数字以外が入力されたため、プログラムを終了します。
```

また、1つの文字列につき最大20バイトまでを読み込む対象とし、それを超える分は読み捨てる。

### 名前の由来

`stdin2list` の `list` の部分はプログラム内部のデータ構造に由来する。

課題の内容からとりあえず名前を決めたらユーザにとって分かりにくい名前になってしまった。

---

## メモ：課題で指定された仕様との差異

課題で指定があったが、変更した、または実装していない仕様等は下記。

### 入力時のプロンプト文字列

指定された仕様では入力時のプロンプト文字列の `：` の直後に半角スペースが存在するが、
入力文字列の区切りが分かりにくいため出力しないようにした。

### ソースコードのインデント

ソースコードのインデントは水平タブ文字(＋幅は半角スペース4文字分)と指定されていたが、
GitHub では水平タブが半角スペース8文字分で表示されて見にくいため
半角スペース4文字に変更した。

## メモ：設計、実装に関する小話

### レイヤーの分離

この課題へ取り組むにあたってはレイヤードアーキテクチャの真似事をしており、
UI層とそれ以外をできるだけ分離する形で設計した。

`list.c` で定義しているリスト操作の各関数は文字列がどこから入力されるかを知らないし、
どこへ出力するかも知らないようになっている。

唯一の例外として `list_add()` で呼び出している `fprintf()` がある。

この `fprintf()` はロガーとして使用しており、本来はロガーの関数を定義して
それを呼び出すのが望ましい(今回はロガーの作成をサボっている)。

一方、UI関連の操作ではリストの内部を直接操作しないようになっている。

文字列の入力、出力の処理におけるリストの操作は全て `list_` で始まる関数を呼び出して実施しており、
`List` のメンバ変数へ直接アクセスしないようにしている。

### 妥協点

C言語で実装する以上、諸々を綺麗にしようとすると膨大な手間と時間がかかるため、
ある程度のことは妥協して(サボって)いる。

下記はその妥協の一部である。

* リスト要素は固定長の文字列とした。汎用的にするのであればリスト要素のメンバは `void *` と
  そのポインタが指す領域のサイズとなるだろう。
* ロガーは `fprintf(stderr, ...)` とした。先述の通り、ロガーの作成をサボっている。
* UI層の処理を `main()` のあるファイル `main.c` に記述している。
  `main()` はレイヤードアーキテクチャにおいてはコントローラのはずなので、
  UI層を担当する関数はファイルを別にするのが望ましいと思う。
  今回の開発規模では特に問題にならないと思い、同じファイルにまとめている。

### 型の命名規則

独自に定義した型は「先頭大文字のキャメル形式」で命名している。

C言語においては `size_t` のように「全て小文字のスネーク形式」か
`FILE` のように「全て大文字」のいずれかが一般的であるとは思う。

しかし、前者に合わせると下記が気になる。
* アンダースコア `_` の分だけ横に長くなる。
* 変数と区別しにくい。
* 型名と同等の変数名を使えない(`list` 型の変数 `list` を定義できない。`List` 型であれば変数 `list` を定義できる)。

また、後者に合わせると下記が気になる。
* 定数と区別しにくい。

上記の点から、C言語において一般的ではないと分かっていたが
「先頭大文字のキャメル形式」で独自の型は命名した。

### リストの走査

下記は `list_add()` 内のリスト走査処理である。

```
// 新規要素の追加位置を決める
ListEntry **entry = &(list->head);
while(*entry != NULL) {
    if(strcmp(new_entry->str, (*entry)->str) <= 0) {
        break;
    }
    entry = &((*entry)->next);
}
// 要素を追加
new_entry->next = *entry;
*entry = new_entry;
```

この処理はリーナス･トーバルズへのインタビュー記事 [Linuxの背後にある精神](http://www.aoky.net/articles/linus_torvalds/the_mind_behind_linux.htm "Linuxの背後にある精神") に出てきた
ソースコード例を~~パクッた~~参考にしている。

よいコードだと思ったのであれば元ネタの記事にも目を通してもらえると嬉しい。
